const DRIFT=.0002;
export default class MarketSystem{constructor(config={state:null}){this.state=config.state}init(){if(!Object.keys(this.state.get().market).length)this.bootstrap();this.t=setInterval(()=>this.tick(),5000)}update(){}destroy(){clearInterval(this.t)}bootstrap(){this.state.patch(s=>{for(let i=0;i<80;i++)s.market[i]={price:+(1+Math.random()*5).toFixed(2),rarity:['Consumer','Industrial','Mil-Spec','Restricted','Classified','Covert','Rare Special'][Math.min(6,Math.floor(Math.random()*7))],liq:500+Math.random()*2500,spread:.01+Math.random()*.03,vol:.02+Math.random()*.06,spark:[2]}})}tick(){this.state.patch(s=>{for(const m of Object.values(s.market)){const dt=1/12,eps=(Math.random()*2-1),shock=(Math.random()<.05?1+(Math.random()*.4-.2):1);const dP=(DRIFT*m.price*dt)+(m.vol*m.price*eps*Math.sqrt(dt));m.price=Math.max(.03,+((m.price+dP)*shock).toFixed(2));m.spark=(m.spark||[]).slice(-39).concat(m.price)};if(Math.random()<.15)s.events.unshift(['Knife demand surge','Covert crash','Collector hype','Liquidity shock'][Math.floor(Math.random()*4)])})}trade(id,size,buy=true){this.state.patch(s=>{const m=s.market[id];if(!m)return;const sl=size/m.liq;const px=m.price*(1+(buy?1:-1)*(m.spread+sl));const cost=px*size;if(buy&&s.wallet>=cost){s.wallet-=cost}else if(!buy){s.wallet+=cost}})}}
